<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Pepper-Telexistence</title>
  <meta name="description" content="360 Pepper's view">
  <script src="js/theta_webrtc.js"></script>
  <script src="js/theta_webrtc_cmd.js"></script>

  <script src="https://aframe.io/releases/0.7.1/aframe.min.js"></script>
  <script>
    function _assert(desc, v) {
      if (v) {
        return;
      }
      else {
        let caller = _assert.caller || 'Top level';
        console.error('ASSERT in %s, %s is :', caller, desc, v);
      }
    }

    function _logStream(stream) {
      console.log(msg + ': id=' + stream.id);
      const videoTracks = stream.getVideoTracks();
      if (videoTracks) {
        console.log('videoTracks.length=' + videoTracks.length);
        for (let i = 0; i < videoTracks.length; i++) {
          const track = videoTracks[i];
          console.log('track.id=' + track.id);
        }
      }

      const audioTracks = stream.getAudioTracks();
      if (audioTracks) {
        console.log('audioTracks.length=' + audioTracks.length);
        for (let i = 0; i < audioTracks.length; i++) {
          const track = audioTracks[i];
          console.log('track.id=' + track.id);
        }
      }
    }
  </script>
  <script type="text/javascript">
  // ----- use skyway room ----
  let myApiKey = '4ff0a85b-4015-4e8b-94f6-4fab24c759e0'; //null; // set your API key
  let peer = null;
  let meshRoom = null;
  const defaultRoomName = '_oculusgo_test_room';

  function getApiKey() {
    let key = document.getElementById('api_key_text').value;
    return key;
  }

  function getApiKeyFromURL() {
    const search = window.location.search;
    const re = new RegExp('apikey=([^&=]+)');
    const results = re.exec(search);
    if (results) {
      //document.getElementById('api_key_text').value = results[1];
      return results[1];
    }

    return null;
  }

  function getRoomFromURL() {
    const search = window.location.search;
    const re = new RegExp('room=([^&=]+)');
    const results = re.exec(search);
    if (results) {
      //document.getElementById('roomname_text').value = results[1];
      return results[1];
    }
  }

  let localStream = null;
  function startMediaAndJoinRoom() {
    const mediaConstraints = {video: false, audio: true};
    navigator.mediaDevices.getUserMedia(mediaConstraints)
    .then( stream => {
      _logStream(stream);
      localStream = stream;
      joinRoom(stream);
    })
    .catch ( err => {
      console.error('getUserMedia ERROR:', err );
    })
  }

  function attachVideo(id, stream) {
    const videoElement = document.getElementById("previewImage");
    videoElement.srcObject = stream;
    videoElement.play();
    console.info("remote media start");
  }

  function detachVideo(id) {
    const videoElement = document.getElementById("previewImage");
    videoElement.pause();
    videoElement.srcObject = null;
    console.info("remote media stop");
  }

  function hideWaitMessage() {
    const element = document.getElementById("wait_massage");
    element.style.display = 'none';
  }

  </script>
  <script>
    AFRAME.registerComponent('play-on-window-click', {
      init: function () {
        this.onClick = this.onClick.bind(this);
      },
      play: function () {
        window.addEventListener('click', this.onClick);
      },
      pause: function () {
        window.removeEventListener('click', this.onClick);
      },
      onClick: function (evt) {
        hideWaitMessage();
        const videoElement = document.getElementById("previewImage");
        videoElement.play();
      }
    });

    AFRAME.registerComponent('hide-once-playing', {
      schema: {type: 'selector'},
      init: function () {
        this.onPlaying = this.onPlaying.bind(this);
        this.onPause = this.onPause.bind(this);
      },
      play: function () {
        if (this.data) {
          this.data.addEventListener('playing', this.onPlaying);
          this.data.addEventListener('pause', this.onPause);
        }
      },
      pause: function () {
        if (this.data) {
          this.data.removeEventListener('playing', this.onPlaying);
          this.data.removeEventListener('pause', this.onPause);
        }
      },
      onPlaying: function (evt) {
        this.el.setAttribute('visible', false);
      },
      onPause: function (evt) {
        this.el.setAttribute('visible', true);
      }
    });

  </script>
</head>

<body onLoad="initPreview();startPreview('2K');">
<div id="wait_massage">Please wait for loading ...</div>
<a-scene>
  <a-assets>
    <video id="previewImage" autoplay loop crossorigin="anonymous" playsinline webkit-playsinline></video>
  </a-assets>
  <a-videosphere src="#previewImage" rotation="0 180 0"
                 play-on-window-click
  >
  </a-videosphere>

  <a-camera user-height="0" wasd-controls-enabled="false" arrow-key-rotation>
    <!-- Text element for display messaging.  Hide once video is playing. -->
    <a-entity id="msg" position="0 -0.3 -1.5" text="align:center;
              width:3;
              wrapCount:100;
              color: #FF8080;
              value:Please click window to start 360 video streaming."
              hide-once-playing="#previewImage">
    </a-entity>
  </a-camera>

</a-scene>
</body>
<script type="text/javascript">
  //joinRoom();
</script>
</html>